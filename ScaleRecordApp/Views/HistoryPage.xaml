<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:ScaleRecordApp.ViewModels"
             x:Class="ScaleRecordApp.Views.HistoryPage"
             x:Name="HistoryPageSelf"
             Title="История взвешиваний">

    <ContentPage.BindingContext>
        <viewmodels:HistoryVM />
    </ContentPage.BindingContext>

    <!-- Кнопка выбора сезона (UI фильтров не засоряем) -->
    <ContentPage.ToolbarItems>
        <ToolbarItem Text="{Binding ActiveSeasonTitle}"
                     Command="{Binding PickSeasonCommand}" />
    </ContentPage.ToolbarItems>

    <Grid RowDefinitions="Auto, Auto, * , Auto" Padding="10">
        <Grid Grid.Row="0" RowDefinitions="Auto,Auto" ColumnDefinitions="*, *" ColumnSpacing="100" Background="AliceBlue">
            <Grid Grid.Row="0" Grid.Column="0" RowDefinitions="Auto,Auto" ColumnDefinitions="*, 1.4*" HorizontalOptions="End">
                <Grid Grid.Row="0" Grid.Column="0">
                    <Label Text="Период:" VerticalOptions="Center" FontSize="16" HorizontalOptions="End"/>
                </Grid>
                <Grid Grid.Row="0" Grid.Column="1">
                    <!--<Grid ColumnDefinitions="250,Auto">-->
                    <HorizontalStackLayout>
                        <Picker 
                                ItemsSource="{Binding RangeOptions}"
                                ItemDisplayBinding="{Binding Title}"
                                SelectedItem="{Binding SelectedRangeOption}"
                                FontSize="16"
                                MinimumWidthRequest="300"
                                TextColor="#2b0b98"/>

                        <Button 
                                Text="↺"
                                FontSize="20"
                                WidthRequest="30"
                                HeightRequest="30"
                                BackgroundColor="Transparent"
                                TextColor="Red"
                                Command="{Binding ResetDateFilterCommand}"/>

                    </HorizontalStackLayout>
                </Grid>
                <Grid Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" >
                    <!-- Ручной период -->
                    <HorizontalStackLayout>
                        <Label Text="С: " VerticalOptions="Center" FontSize="16"/>
                        <DatePicker Date="{Binding FilterFromDate}" TextColor="#2b0b98" FontSize="16"
                 IsEnabled="{Binding IsCustomRange}"/>
                        <TimePicker Time="{Binding FilterFromTime}" TextColor="#2b0b98" FontSize="16"
                 IsEnabled="{Binding IsCustomRange}"/>
                        <Label Text="По: " VerticalOptions="Center" FontSize="16" Margin="20,0,0,0"/>
                        <DatePicker Date="{Binding FilterToDate}" TextColor="#2b0b98" FontSize="16"
                 IsEnabled="{Binding IsCustomRange}"/>
                        <TimePicker Time="{Binding FilterToTime}" TextColor="#2b0b98" FontSize="16"
                 IsEnabled="{Binding IsCustomRange}"/>
                    </HorizontalStackLayout>
                </Grid>
            </Grid>
            
            <Grid Grid.Row="0" Grid.Column="1" ColumnDefinitions="Auto, Auto, Auto" RowDefinitions="*,*" HorizontalOptions="Start">
                <Grid Grid.Column="0" Grid.Row="0">
                    <Label Text="Машина:" VerticalOptions="Center" FontSize="16" HorizontalOptions="End"/>
                </Grid>
                <Grid Grid.Column="0" Grid.Row="1">
                    <Label Text="Груз:" VerticalOptions="Center" FontSize="16" Margin="20,0,0,0" HorizontalOptions="End"/>
                </Grid>
                <Grid Grid.Column="1" Grid.Row="0">
                    <Grid Grid.Column="1" Grid.Row="0" ColumnDefinitions="300,Auto">
                        <Picker Grid.Column="0"
                                ItemsSource="{Binding Vehicles}"
                                ItemDisplayBinding="{Binding Name}"
                                SelectedItem="{Binding SelectedVehicle}"
                                TextColor="#2b0b98"
                                FontSize="16"/>
                        <Button Grid.Column="1"
                                Text="↺" FontSize="20"
                                WidthRequest="30" HeightRequest="30"
                                BackgroundColor="Transparent" TextColor="Red"
                                Command="{Binding ResetVehicleFilterCommand}"/>
                    </Grid>
                </Grid>
                <Grid Grid.Column="1" Grid.Row="1">
                    <Grid Grid.Column="1" Grid.Row="1" ColumnDefinitions="300,Auto">
                        <Picker Grid.Column="0"
                                ItemsSource="{Binding CargoTypes}"
                                ItemDisplayBinding="{Binding DisplayName}"
                                SelectedItem="{Binding SelectedCargoType}"
                                TextColor="#2b0b98"
                                FontSize="16"/>
                        <Button Grid.Column="1"
                                Text="↺" FontSize="20"
                                WidthRequest="30" HeightRequest="30"
                                BackgroundColor="Transparent" TextColor="Red"
                                Command="{Binding ResetCargoFilterCommand}"/>
                    </Grid>
                </Grid>
                <Grid Grid.Column="2" Grid.RowSpan="2" >
                    <Button Text="Сбросить все фильтры"
                            Padding="10"
                            VerticalOptions="Center"
                            HorizontalOptions="Center"
                            LineBreakMode="WordWrap"
                            Command="{Binding ResetAllFiltersCommand}"
                            WidthRequest="120"
                            Margin="20,0,0,0"/>
                </Grid>
                
                
                
                
                
                
            </Grid>
            <Grid Grid.Row="1" Grid.ColumnSpan="2" ColumnDefinitions="*, *" HorizontalOptions="Center" ColumnSpacing="145">
                <Grid Grid.Column="0">
                    <Grid ColumnDefinitions="Auto, 300, Auto">
                        <Label Grid.Column="0" Text="Откуда:" VerticalOptions="Center" FontSize="16" HorizontalOptions="End"/>
                        <Picker Grid.Column="1"
                                ItemsSource="{Binding Destinations}"
                                ItemDisplayBinding="{Binding Name}"
                                SelectedItem="{Binding SelectedFrom}"
                                TextColor="#2b0b98"
                                FontSize="16"/>         
                        <Button Grid.Column="2"
                                Text="↺" FontSize="20"
                                WidthRequest="30" HeightRequest="30"
                                BackgroundColor="Transparent" TextColor="Red"
                                Command="{Binding ResetFromFilterCommand}"/>
                    </Grid>
                </Grid>
                <Grid Grid.Column="1" >
                    <Grid ColumnDefinitions="Auto, 300, Auto">
                        <Label Grid.Column="0" Text="Куда:" VerticalOptions="Center" FontSize="16" HorizontalOptions="End"/>
                        <Picker Grid.Column="1"
                                ItemsSource="{Binding Destinations}"
                                ItemDisplayBinding="{Binding Name}"
                                SelectedItem="{Binding SelectedTo}"
                                TextColor="#2b0b98"
                                FontSize="16"/>
                        <Button Grid.Column="2"
                                Text="↺" FontSize="20"
                                WidthRequest="30" HeightRequest="30"
                                BackgroundColor="Transparent" TextColor="Red"
                                Command="{Binding ResetToFilterCommand}"/>
                    </Grid>
                </Grid>
            </Grid>
        </Grid>    

        <!-- Заголовки -->
        <Grid Grid.Row="1" ColumnDefinitions="*,*,1.3*,*,*,*,*,*"
              Padding="4" ColumnSpacing="1">
            <Button Text="{Binding DateHeaderText}" BackgroundColor="Transparent" TextColor="Black"
                    Command="{Binding SortCommand}" CommandParameter="Timestamp"/>
            <Button Grid.Column="1" Text="{Binding VehicleHeaderText}" BackgroundColor="Transparent" TextColor="Black"
                    Command="{Binding SortCommand}" CommandParameter="Vehicle"/>
            <Button Grid.Column="2" Text="{Binding CargoHeaderText}" BackgroundColor="Transparent" TextColor="Black"
                    Command="{Binding SortCommand}" CommandParameter="Cargo"/>
            <Button Grid.Column="3" Text="{Binding NetWeightHeaderText}" BackgroundColor="Transparent" TextColor="Black"
                    Command="{Binding SortCommand}" CommandParameter="NetWeight"/>
            <Button Grid.Column="4" Text="{Binding FromHeaderText}" BackgroundColor="Transparent" TextColor="Black"
                    Command="{Binding SortCommand}" CommandParameter="From"/>
            <Button Grid.Column="5" Text="{Binding ToHeaderText}" BackgroundColor="Transparent" TextColor="Black"
                    Command="{Binding SortCommand}" CommandParameter="To"/>
            <Button Grid.Column="6" Text="{Binding SourceHeaderText}" BackgroundColor="Transparent" TextColor="Black"
                    Command="{Binding SortCommand}" CommandParameter="Source"/>
            <Button Grid.Column="7" Text="{Binding CommentHeaderText}" BackgroundColor="Transparent" TextColor="Black"
                    Command="{Binding SortCommand}" CommandParameter="Comment"/>
        </Grid>

        <!-- Таблица -->
        <!--<ScrollView Grid.Row="2">-->
            <CollectionView ItemsSource="{Binding Records}" SelectionMode="None" Grid.Row="2">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid ColumnDefinitions="*,Auto,*,Auto,1.3*,Auto,*,Auto,*,Auto,*,Auto,*,Auto,*"
                              Padding="0" ColumnSpacing="1"
                              BackgroundColor="#e0e0e0">
                            <Grid.GestureRecognizers>
                                <TapGestureRecognizer
                                    Command="{Binding BindingContext.ShowDetailsCommand, Source={x:Reference HistoryPageSelf}}"
                                    CommandParameter="{Binding .}" />
                            </Grid.GestureRecognizers>

                            <Label Grid.Column="0" Text="{Binding Timestamp, StringFormat='{0:dd.MM.yyyy HH:mm}'}"
                                   LineBreakMode="TailTruncation" MaxLines="1" Margin="4" HorizontalTextAlignment="Center"/>
                            <BoxView Grid.Column="1" WidthRequest="1"/>
                            <Label Grid.Column="2" Text="{Binding VehicleName}"
                                   LineBreakMode="TailTruncation" MaxLines="1" HorizontalTextAlignment="Center"/>
                            <BoxView Grid.Column="3" WidthRequest="1"/>   
                            <Label Grid.Column="4" Text="{Binding CargoDisplay}"
                                   LineBreakMode="TailTruncation" MaxLines="1" HorizontalTextAlignment="Center"/>
                            <BoxView Grid.Column="5" WidthRequest="1"/>
                            <Label Grid.Column="6" Text="{Binding NetWeight, StringFormat='{0:F0}'}"
                                   LineBreakMode="TailTruncation" MaxLines="1" HorizontalTextAlignment="Center"/>
                            <BoxView Grid.Column="7" WidthRequest="1"/>
                            <Label Grid.Column="8" Text="{Binding FromName}"
                                   LineBreakMode="TailTruncation" MaxLines="1" HorizontalTextAlignment="Center"/>
                            <BoxView Grid.Column="9" WidthRequest="1"/>
                            <Label Grid.Column="10" Text="{Binding ToName}"
                                   LineBreakMode="TailTruncation" MaxLines="1" HorizontalTextAlignment="Center"/>
                            <BoxView Grid.Column="11" WidthRequest="1"/>    
                            <Label Grid.Column="12" Text="{Binding SourceName}"
                                   LineBreakMode="TailTruncation" MaxLines="1" HorizontalTextAlignment="Center"/>
                            <BoxView Grid.Column="13" WidthRequest="1"/>
                            <Label Grid.Column="14" Text="{Binding Comment}"
                                   LineBreakMode="TailTruncation" MaxLines="1" HorizontalTextAlignment="Center"/>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        <!--</ScrollView>-->

        <!-- Итог + форма отправки -->
        <Grid Grid.Row="3" ColumnDefinitions="Auto,*" ColumnSpacing="10" Padding="0,10,0,0">
            <HorizontalStackLayout Grid.Column="0" Spacing="6" VerticalOptions="Center" HorizontalOptions="Start">
                <Entry WidthRequest="260"
                       Placeholder="Telegram username или chat id"
                       Text="{Binding TelegramRecipient}" />
                <Button Text="Отправить отчет"
                        Command="{Binding SendFilteredReportCommand}"
                        IsEnabled="{Binding IsNotSending}" />
            </HorizontalStackLayout>

            <Label Grid.Column="1"
                   Text="{Binding TotalNetTonsText}"
                   FontAttributes="Bold"
                   FontSize="25"
                   HorizontalOptions="End" />
        </Grid>

    </Grid>
</ContentPage>

